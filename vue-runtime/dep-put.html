<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>vue数据响应</title>
</head>
<body>
    <div id="app">
        {{name}}
        <br>
        {{age}}
    </div>
</body>
<script>
    // 订阅者
    function Waccher(vm, node, name){
        Det.target = this
    }
    // 主题对象构造函数
    function Dep(){
        this.subs = [] //存放这个属性对应的watch
    }
    Dep.prototype = {
        addSub:function(sub){
            this.subs.push(sub)
        },
        // 派发更新
        notify:function(){
            this.subs.forEach(sub => {
                sub.update( )
            })
        }
    }
    // 观察者
    function observe(obj,vm){
        // console.log(Object.keys(obj));
        Object.keys(obj).forEach(key =>{
            defineReactive(vm,key,obj[key])
        })
    };
    // defineProperty直接把data上面的数据定义到vm实例上
    function defineReactive(obj,key,val){
        // 声明对应属性的依赖手机主题对象实例
        let dep = new Dep()
        Object.defineProperty(obj,key,{
            get:function(){
                console.log(Dep.target);
                if(Dep.target){
                    dep.addSub(Dep.target )
                }
                console.log(`获取${key}`);
                return val;
            },
            set:function(newValue){
                if(val === newValue){
                    return
                }
                val = newValue
                console.log(`设置${newValue}`);
                dep.notify()
                 
            },
        })
    }
    // 编译
    function compile(node,vm){
        let reg = /\{\{(.*)\}\}/
        if(node.nodeType === 3){
            if(reg.test(node.nodeValue)){
                // 获取正则的第一个值
                var name = RegExp.$1
                // 清空空格
                name = name.trim()
                node.textContent =vm.data[name]
            }
        }
    }
    // dom节点劫持
    function nodeToFragment(node,vm){
        // 文档树的片段 不直接操作真实的Dom
        let flag = document.createDocumentFragment()
        let child 
        while(child = node.firstChild){
            compile(child,vm)
            flag.appendChild(child)
        }
        return flag
    }
    // 定义vue
    function Vue(options){
        this.data = options.data
        let _id = document.querySelector(options.el)
        // 对data进行监听
        observe(this.data,this)
        let _dom = nodeToFragment(_id,this)
        _id.appendChild(_dom)

    }

    const app = new Vue({
        el:'#app',
        data:{
            name:'睡不着',
            age:'18'
        }
    })
    console.log(app);
</script>
</html>